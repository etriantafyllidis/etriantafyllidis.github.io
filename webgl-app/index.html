<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>AR Model Viewer</title>
    <script src="https://aframe.io/releases/1.2.0/aframe.min.js"></script>
    <script src="https://cdn.jsdelivr.net/gh/AR-js-org/AR.js@3.3.2/aframe/build/aframe-ar.min.js"></script>
</head>
<body style="margin: 0; overflow: hidden;">
    <a-scene embedded arjs>
        <a-marker preset="hiro" id="hiroMarker">
            <a-entity id="modelEntity" gltf-model="#model" position="0 0 0" scale="0.25 0.25 0.25" rotation="0 0 0" gesture-handler></a-entity>
        </a-marker>
        <a-entity camera></a-entity>
    </a-scene>

    <a-assets>
        <a-asset-item id="model" src="model.gltf"></a-asset-item>
    </a-assets>

    <script>// Marker visibility handling
        const marker = document.querySelector('#hiroMarker');
        const modelEntity = document.querySelector('#modelEntity');

        let lastPosition = { x: 0, y: 0, z: 0 };
        let lastRotation = { x: 0, y: 0, z: 0 };
        let markerFound = false;

        marker.addEventListener('markerFound', (event) => {
            console.log('Marker found!');
            modelEntity.setAttribute('visible', true);
            markerFound = true;
        });

        marker.addEventListener('markerLost', (event) => {
            console.log('Marker lost!');
            markerFound = false;
            lastPosition = modelEntity.object3D.position.clone();
            lastRotation = modelEntity.object3D.rotation.clone();
        });

        AFRAME.registerComponent('gesture-handler', {
            schema: {
                enabled: { default: true }
            },
            init: function () {
                this.handleScale = this.handleScale.bind(this);
                this.handleRotation = this.handleRotation.bind(this);
                this.handleMovement = this.handleMovement.bind(this);
            },
            tick: function () {
                if (!markerFound) {
                    modelEntity.object3D.position.copy(lastPosition);
                    modelEntity.object3D.rotation.copy(lastRotation);
                }
            },
            play: function () {
                this.el.sceneEl.addEventListener('onefingermove', this.handleMovement);
                this.el.sceneEl.addEventListener('twofingermove', this.handleRotation);
                this.el.sceneEl.addEventListener('twofingerscale', this.handleScale);
            },
            pause: function () {
                this.el.sceneEl.removeEventListener('onefingermove', this.handleMovement);
                this.el.sceneEl.removeEventListener('twofingermove', this.handleRotation);
                this.el.sceneEl.removeEventListener('twofingerscale', this.handleScale);
            },
            handleScale: function (event) {
                var scale = modelEntity.getAttribute('scale');
                scale.x *= event.detail.spreadChange;
                scale.y *= event.detail.spreadChange;
                scale.z *= event.detail.spreadChange;
                modelEntity.setAttribute('scale', scale);
            },
            handleRotation: function (event) {
                var rotation = modelEntity.getAttribute('rotation');
                rotation.y += event.detail.angleChange;
                modelEntity.setAttribute('rotation', rotation);
            },
            handleMovement: function (event) {
                var rotation = modelEntity.getAttribute('rotation');
                rotation.y += event.detail.positionChange.x * 0.5;
                rotation.x -= event.detail.positionChange.y * 0.5;
                modelEntity.setAttribute('rotation', rotation);
            }
        });</script>
</body>
</html>
